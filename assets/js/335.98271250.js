(window.webpackJsonp=window.webpackJsonp||[]).push([[335],{1517:function(t,a,s){t.exports=s.p+"assets/img/canvas-backingstore-device.ab91cf70.png"},2636:function(t,a,s){"use strict";s.r(a);var n=s(46),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"问题剖析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题剖析"}},[t._v("#")]),t._v(" 问题剖析")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[n("RouterLink",{attrs:{to:"/front-end/Visual/front-end/engineering/flexible.html#一些概念"}},[t._v("移动端适配方案")]),t._v("中对物理像素(physical pixel)、CSS像素和devicePixelRatio等概念进行了介绍")],1)]),t._v(" "),n("p",[t._v("在高清屏中，Canvas绘制时会出现模糊问题，在文章"),n("a",{attrs:{href:"https://www.html5rocks.com/en/tutorials/canvas/hidpi/",target:"_blank",rel:"noopener noreferrer"}},[t._v("High DPI Canvas"),n("OutboundLink")],1),t._v("中对比进行了分析介绍。其中涉及两个概念:"),n("span",{staticStyle:{color:"blue"}},[t._v("webkitBackingStorePixelRatio和devicePixelRatio")])]),t._v(" "),n("p",[t._v("浏览器绘制Canvas渲染到屏幕中分两个过程")]),t._v(" "),n("ul",[n("li",[n("p",[n("span",{staticStyle:{color:"blue"}},[t._v("绘制过程:webkitBackingStorePixelRatio")])]),t._v(" "),n("p",[t._v("webkitBackingStorePixelRatio表示浏览器在绘制Canvas到缓存区时的绘制比例，若图片宽高为200px，webkitbackingStorePixelRatio为2，那么Canvas绘制这个图片到缓存区时，宽高为400px;")])]),t._v(" "),n("li",[n("p",[n("span",{staticStyle:{color:"blue"}},[t._v("渲染过程：devicePixelRatio")])]),t._v(" "),n("p",[t._v("Canvas显示到屏幕中还需要渲染过程，渲染过程根据devicePixelRatio参数将缓存区中的canvas进行缩放渲染到屏幕中")])])]),t._v(" "),n("p",[n("img",{attrs:{src:s(1517),alt:"浏览器绘制过程"}})]),t._v(" "),n("p",[t._v("分析图片在高清屏中Canvas绘制会模糊的原因:")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("devicePixelRatio = device pixel / CSS pixel")]),t._v(" "),n("p",[t._v("如果devicePixelRatio = 2 那么对于200px * 200px的图片要绘制到屏幕中，那么对应的屏幕像素(物理像素)就是400px * 400px")])]),t._v(" "),n("li",[n("p",[t._v("在大部分高清屏中，例如Macbook Pro中")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("webkitBackingStorePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ndevicePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])]),t._v(" "),n("p",[t._v("将一个200px * 200px 的图片Canvas绘制到该屏幕中的流程")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("webkitBackingStorePixelRatio = 1;")]),t._v(" "),n("p",[t._v("绘制到缓存区的大小也为：200px * 200px;")])]),t._v(" "),n("li",[n("p",[t._v("devicePixelRatio = 2;")]),t._v(" "),n("p",[t._v("200px * 200px 的图片对应到屏幕像素为400px * 400px ,devicePixelRatio = 2浏览器就把缓存区的200px * 200px 宽高分别放到两倍渲染到到屏幕中，所以导致模糊")])])]),t._v(" "),n("h2",{attrs:{id:"解决方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("将Canvas宽高进行方法，放大比例为：devicePixelRatio / webkitBackingStorePixelRatio")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" devicePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("devicePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" backingStoreRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("webkitBackingStorePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" \n                    context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mozBackingStorePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n                    context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("msBackingStorePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n                    context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("oBackingStorePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n                    context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("backingStorePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" ratio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" devicePixelRatio "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" backingStoreRatio\n")])])])]),t._v(" "),n("li",[n("p",[t._v("通过css设置将Canva缩小为原大小")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" oldWidth "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" canvas"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("width"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" oldHeight "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" canvas"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("height"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncanvas"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("width "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldWidth"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ncvans"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("height "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldWidth"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncanvas"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("width "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldWidth "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'px'")]),t._v("\ncanvas"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("height "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldHeight "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'px'")]),t._v("\n")])])])])]),t._v(" "),n("p",[t._v("举例分析一下Canvas绘制图片，文字的适配方案：")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("对于图片绘制drawImage方法")]),t._v(" "),n("p",[t._v("由于Canvas放大后，相应的绘制图片时也要放大，有两种方式")]),t._v(" "),n("ul",[n("li",[t._v("drawImage目标宽高分别乘以ratio")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("drawImage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("image"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" srcx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" srcy"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" srcw"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" srch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" desx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" desy"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" desw "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" desh "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("ul",[n("li",[t._v("context.scale缩放")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("scale")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 绘制图片")]),t._v("\ncontext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("drawImage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncontext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("scale")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("此种方式在绘制图片之前，调用 scale 设置 Canvas 缩放变换；绘制完成后，需要重置 Canvas 的缩放变换。推荐使用这种方式 👍")])])]),t._v(" "),n("ul",[n("li",[n("p",[t._v("对于文字绘制fillText方法")]),t._v(" "),n("p",[t._v("由于Canvas方法了，绘制文字时，字体也要放大，绘制完毕后，字体要缩小会原大小")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("font "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("font"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[n("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("(\\d+)(px|em|rem|pt)")]),n("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("w"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" u")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" u"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 绘制文字")]),t._v("\ncontext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fillText")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncontext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("font "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("font"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token regex"}},[n("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("(\\d+)(px|em|rem|pt)")]),n("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token regex-flags"}},[t._v("g")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("w"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" u")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" ratio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" u"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])]),t._v(" "),n("p",[t._v("关于 Canvas 在高清屏绘制的兼容，github 有一个 "),n("a",{attrs:{href:"https://github.com/jondavidjohn/hidpi-canvas-polyfill",target:"_blank",rel:"noopener noreferrer"}},[t._v("polyfill jondavidjohn/hidpi-canvas-polyfill"),n("OutboundLink")],1),t._v(" 但是这仓库并没有考虑 drawImage，如果直接使用这个 polyfill，在绘制图片时，宽高都会变小；我 fork 了这个仓库，并增加了 drawImage 处理：YingshanDeng/hidpi-canvas-polyfill。更多 Canvas 绘制方法的兼容参考这个仓库的源码。")]),t._v(" "),n("h2",{attrs:{id:"其他"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[t._v("#")]),t._v(" 其他")]),t._v(" "),n("p",[t._v("1️⃣  webkitBackingStorePixelRatio 在 Chrome 中已经废弃，详细参考：https://bugs.chromium.org/p/chromium/issues/detail?id=277205")]),t._v(" "),n("p",[t._v("2️⃣  现在高清屏中 Canvas 绘制图片 drawImage，不需要经过如上处理也不会出现模糊的情况了（只在 Mackbook Pro, iPhone 6S 上分别测试过），这点在网上并没有找到更多的信息")]),t._v(" "),n("p",[t._v("但是 Canvas 的其他绘制方法例如绘制文字 fillText 不经过处理高清屏中绘制仍然会模糊，所以还是需要这个polyfill：YingshanDeng/hidpi-canvas-polyfill")]),t._v(" "),n("h2",{attrs:{id:"资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#资料"}},[t._v("#")]),t._v(" 资料")]),t._v(" "),n("p",[n("a",{attrs:{href:"http://objcer.com/2017/10/10/High-DPI-Canvas-Render/",target:"_blank",rel:"noopener noreferrer"}},[t._v("高清屏中 Canvas 的绘制"),n("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);